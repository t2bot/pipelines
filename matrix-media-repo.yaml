steps_DENDRITE_TEST:
  - label: "ü§ù Complement"
    env:
      COMPLEMENT_BASE_IMAGE: complement-dendrite
      COMPLEMENT_VERSION_CHECK_ITERATIONS: 400
    commands: 
      - "echo '--- install go 1.14'"
      - "curl -L https://golang.org/dl/go1.14.6.linux-amd64.tar.gz > go.tar.gz"
      - "tar -C . -xzf go.tar.gz"
      - "echo '--- make docker image'"
      - "git clone --depth=1 https://github.com/matrix-org/complement.git tmp"
      - "docker build -t complement-dendrite -f ./tmp/dockerfiles/Dendrite.Dockerfile ./tmp/dockerfiles"
      - "echo '+++ run tests'"
      - "chmod +x ci-complement.sh" # To fix the script
      - "PATH=$PATH:$(pwd)/go/bin ./ci-complement.sh"
steps:
  - label: "üî® Build :go: 1.14"
    commands: 
      - "echo '+++ build'"
      - "./build.sh"
    plugins:
      - docker#v3.0.1:
          image: "golang:1.14"
          mount-buildkite-agent: false
  - label: "ü§ù Complement"
    env:
      COMPLEMENT_BASE_IMAGE: complement-media-repo
      COMPLEMENT_VERSION_CHECK_ITERATIONS: 400
    commands: 
      - "echo '--- prepare image'"
      - "docker build -t complement-media-repo -f Complement.Dockerfile ."
      - "echo '+++ run tests'"
      - "chmod +x ci-complement.sh" # To fix the script
      - "./ci-complement.sh"
    plugins:
      - docker#v3.5.0:
          # The dockerfile for this image is at https://github.com/matrix-org/complement/blob/master/dockerfiles/ComplementCIBuildkite.Dockerfile.
          image: "matrixdotorg/complement:latest"
          mount-buildkite-agent: false
          # Complement needs to know if it is running under CI
          environment:
           - "CI=true"
          publish: [ "8448:8448" ]
          # Complement uses Docker so pass through the docker socket. This means Complement shares
          # the host's Docker.
          volumes:
            - "/var/run/docker.sock:/var/run/docker.sock"
